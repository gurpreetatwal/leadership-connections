<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Leadership Connections</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-amber.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://unpkg.com/vue"></script>

    <style>
      html {
        height: 100%;
        font-family: "Roboto","Helvetica","Arial",sans-serif;

        background: #1c92d2;
        background: -webkit-linear-gradient(to bottom, #f2fcfe, #1c92d2);
        background: linear-gradient(to bottom, #f2fcfe, #1c92d2);
        /*
        background: url('background.jpg');
        background-position: 50%;
        background-attachment: fixed;
        background-size: cover;
        background-repeat: no-repeat;
        */
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        height: 100%;
        display: flex;
        align-items: center;
        flex-direction: column;
        justify-content: center;
      }

      p.signup {
        padding: 15px;
        background: #ecf0f1;
      }

      .center {
        text-align: center;
      }

      .mdl-card {
        min-height: auto;
        align-items: center;
      }

      #graph-container {
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        position: absolute;
      }
      .mdl-button--file  input {
        cursor: pointer;
        height: 100%;
        right: 0;
        opacity: 0;
        position: absolute;
        top: 0;
        width: 300px;
        z-index: 4;
      }

      .mdl-textfield--file  .mdl-textfield__input {
        box-sizing: border-box;
        width: calc(100% - 32px);
      }
      .mdl-textfield--file  .mdl-button--file {
        right: 0;
      }

      #submit {
        margin-top: 16px;
        margin-bottom: 32px;
      }

      #connection-current {
        width: 100%;
        padding: 0 32px;
      }

      #connection-previous {
        width:100%;
        margin-top: 16px;
        border-top: 1px solid #ccc;
        padding: 16px;
        max-height: 40vh;
        overflow-y: scroll;
      }

    </style>

  </head>
  <body>
    <div id="graph-container"></div>

    <main id="app">
      <div class="mdl-card mdl-shadow--2dp">

        <p class="signup" v-show="signup"> Looks like you haven't signed up yet, please upload a profile image and click the submit but to signup. </p>

        <div class="mdl-textfield mdl-js-textfield">
          <input class="mdl-textfield__input" type="text" id="sample1">
          <label class="mdl-textfield__label" for="sample1">Your name...</label>
        </div>

        <div v-show="signup" class="mdl-textfield mdl-js-textfield mdl-textfield--file">
          <input class="mdl-textfield__input" placeholder="Profile Picture" type="text" id="uploadFile" readonly/>
          <div class="mdl-button mdl-button--primary mdl-button--icon mdl-button--file">
            <i class="material-icons">photo_library</i><input type="file" id="uploadBtn">
          </div>
        </div>

        <button v-show="signup" id="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
          Signup
        </button>

      </div>

      <div v-if="pairings" style="margin-top: 16px;" class="mdl-card mdl-shadow--2dp">

        <p class="center" style="padding: 16px 16px 0; font-size: 16px;">This Week's Connection</p>

        <div id="connection-current" class="mdl-list__item">
          <span class="mdl-list__item-primary-content">
            <img class="mdl-list__item-avatar" :src="pairings[0].pair.image">
            {{pairings[0].pair.name}}
          </span>
          <span class="mdl-list__item-secondary-action">
            <div class="mdl-button mdl-button--primary mdl-button--icon mdl-button--file">
              <i class="material-icons">photo_library</i><input type="file" id="uploadBtn">
            </div>
          </span>
        </div>

        <ul id="connection-previous" class="mdl-list">
          <p class="center">Previous Connections<br><small>(in descending order)</small></p>
          <li v-for="pairing in pairings" class="mdl-list__item">
            <span class="mdl-list__item-primary-content">
              <img class="mdl-list__item-avatar" :src="pairing.pair.image">
              {{pairing.pair.name}}
            </span>
            <span class="mdl-list__item-secondary-action">
              <div class="mdl-button mdl-button--primary mdl-button--icon mdl-button--file">
                <i class="material-icons">photo_library</i><input type="file" id="uploadBtn">
              </div>
            </span>
          </li>

        </ul>

      </div>
    </main>

    <!-- 3rd Party Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js" integrity="sha256-ii2D7w2jthCadZtIl2OjRn2vu1iEtGWcOrmd+UOZorc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.plugins.animate.min.js" integrity="sha256-D65uSr6qp3GRxCPrwPhBUaXXFsKoFqBtyIwxyspHrho=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.noverlap.min.js" integrity="sha256-v8Yw4oU0hwLlTu4QhmJLxKSDkmXFubs1lYHavjYB2dg=" crossorigin="anonymous"></script>

    <!-- Custom Scripts -->
    <script src="js/sigma.renderer.js"></script>
    <script src="js/student-graph.js"></script>
    <script>

      const data = {
        signup: false,
        pairings: false,
      };

const app = new Vue({
  el: '#app',
  data,
});

function addTypedEvent(el) {
  let timerId = null;
  const cb = () => el.dispatchEvent(new CustomEvent('typed', {detail: el.value}));
  el.addEventListener('input', function() {
    data.signup = false;
    data.pairings = false;
    clearTimeout(timerId);
    timerId = setTimeout(cb, 1000);
  });
}

function getStudent({detail: name}) {

  fetch(`/pairing?name=${name}`)
    .then((r) => {
      if (r.ok) return r;
      const e = new Error();
      e.response = r;
      throw e;
    })
    .then((r) => r.json())
    .then(function(pairings) {

      data.signup = false;
      data.pairings = pairings.map((pair) => ({
        week: pair.week,
        image: pair.image,
        pair: pair.student_1.name.toLowerCase() === name.toLowerCase() ? pair.student_2 : pair.student_1,
      })).reverse();
    })
    .catch(function(e) {

      if (e.response.status === 404) {
        data.signup = true;
        data.pairings = false;
      }

    });
}

const input = document.getElementById('sample1');
addTypedEvent(input);
input.addEventListener('typed', getStudent, true);


fetch('/student')
  .then((r) => r.json())
  .then(function(students) {

    new StudentGraph('graph-container', students);
    console.log(students);

  });

    </script>
  </body>
</html>
